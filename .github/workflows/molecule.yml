---
name: molecule
on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  workflow_dispatch:
    inputs:
      molecule_scenario:
        description: 'Molecule scenario to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - default
          - ubuntu-2404
      debug_mode:
        description: 'Enable debug mode for verbose output'
        required: false
        default: false
        type: boolean

jobs:
  lint:
    name: Lint Syntax Checks
    runs-on: ubuntu-latest
    container: 
      image: ghcr.io/ginanck/molecule-runner:python3.12-2.15.13
    steps:
      - name: Check out the codebase
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Download linter configurations
        run: |
          curl -fsSL https://raw.githubusercontent.com/ginanck/shared-pre-commit-hooks/master/config/ansible-lint.yml -o ansible-lint.yml
          curl -fsSL https://raw.githubusercontent.com/ginanck/shared-pre-commit-hooks/master/config/yamllint.yml -o yamllint.yml
          curl -fsSL https://raw.githubusercontent.com/ginanck/shared-pre-commit-hooks/master/config/flake8.conf -o flake8.conf

      - name: Run ansible-lint
        run: |
          ansible-lint -c ansible-lint.yml .

      - name: Run yamllint
        run: |
          yamllint -c yamllint.yml .

      - name: Run flake8
        run: |
          flake8 --config=flake8.conf .

  prepare:
    name: Prepare Matrix
    runs-on: ubuntu-latest
    outputs:
      scenarios: ${{ steps.set-matrix.outputs.scenarios }}
    steps:
      - name: Check out the codebase
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Set matrix scenarios
        id: set-matrix
        run: |
          set -euo pipefail
          input="${{ github.event.inputs.molecule_scenario || 'all' }}"

          if [ "$input" = "all" ]; then
            scenarios_list=()
            if [ -d "molecule" ]; then
              for dir in molecule/*; do
                [ -d "$dir" ] || continue
                name="$(basename "$dir")"
                if [ -f "$dir/molecule.yml" ] || [ -f "$dir/molecule.yaml" ]; then
                  scenarios_list+=("$name")
                fi
              done
            fi

            if [ "${#scenarios_list[@]}" -eq 0 ]; then
              echo "No scenario detected or selected! Please configure your molecule scenarios!" >&2
              exit 1
            fi

            # build JSON array from list
            scenarios="$(printf '%s\n' "${scenarios_list[@]}" | jq -R -s -c 'split("\n")[:-1]')"
          else
            # single scenario requested: validate it exists and has molecule.yml
            sel="$input"
            if [ -d "molecule/$sel" ] && ( [ -f "molecule/$sel/molecule.yml" ] || [ -f "molecule/$sel/molecule.yaml" ] ); then
              scenarios="$(jq -n --arg s "$sel" '[$s]')"
            else
              echo "No scenario detected or selected! Please configure your molecule scenarios!" >&2
              exit 1
            fi
          fi

          echo "Found scenarios: $scenarios"
          echo "scenarios=$scenarios" >> $GITHUB_OUTPUT

  molecule:
    name: Molecule Test
    needs: prepare
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/ginanck/molecule-runner:python3.12-2.15.13
      volumes:
        - /var/run/docker.sock:/var/run/docker.sock
    strategy:
      fail-fast: false
      matrix:
        scenario: ${{ fromJson(needs.prepare.outputs.scenarios || '["default"]') }}
    env:
      DOCKER_HOST: 'unix:///var/run/docker.sock'
    steps:
      - name: Check out the codebase
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Run Molecule tests for ${{ matrix.scenario }} scenario
        run: |
          if [ "${{ github.event.inputs.debug_mode }}" == "true" ]; then
            molecule --debug -vvv test -s ${{ matrix.scenario }}
          else
            molecule test -s ${{ matrix.scenario }}
          fi
        env:
          PY_COLORS: '1'
          ANSIBLE_FORCE_COLOR: '1'
